<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="DPIE Emissions Tool - Data Preparation Tool">
    <meta name="author" content="Little Sketches // Point Advisory">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;400;700&display=swap" rel="stylesheet">
    <style>
        /** NSW GOV COLOUR PALETTE CSS VARIABLES ***/
            :root {
              --netzero-forest: #005468;
              --netzero-aqua: #4FC6E0;
            }
        /** CORE ELEMENTS **/
            body {
                font-weight: 300;
                font-family: 'Montserrat', sans-serif;
                overflow-y: scroll;
                overflow-x: hidden;
                margin: 0;
            }
            html, body, .perspective {
                width: 100%;
                height: 100%;
            }
        /** MAIN CONTENT **/
            #content{
                height: 100vh;
                overflow: scroll;
            }   
            #content-bg{
                position: fixed;
                top: 0;
                right: 0;
                height: 100vh;
            }
            #nswGov-watermark path{
                fill: rgba(255, 255, 255, 0.1);
            }
            .perspective {
                background: var(--netzero-forest);
                position: relative;
                -webkit-perspective: 1500px;
                perspective: 1500px;        
            }

        /** MODAL VIEW **/
            .perspective.modalview {
                position: fixed;
                -webkit-perspective: 1500px;
                perspective: 1500px;
            }
            .modalview .container {
                position: absolute;
                overflow: hidden;
                width: 100%;
                height: 100%;
                cursor: pointer;
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
            .modalview .wrapper {
                -webkit-transform: translateZ(-1px); /* solves a rendering bug in Chrome on Windows */
            }
            .modalview .container::after {
                opacity: 1;
                height: 101%;
                -webkit-transition: opacity 0.3s;
                transition: opacity 0.3s;
            }

            #hidden-file-upload{
                display: none;
            }

        /** MAIN MENU | LEFT SIDE BG **/
            .main-nav {
                position: absolute;
                height: auto;
                left: 15%;      
                top: 50%;
                -webkit-transform: translateY(-50%);
                transform: translateY(-50%);
                -webkit-transform-style: preserve-3d;
                transform-style: preserve-3d;
            }
            #mainMenu-container{
                color: #fff;
            }
            .mainMenu-header{
                font-weight: bold;
                font-size: 1.75rem;
            }
            .mainMenu-option{
                margin-top: 2vh;
                margin-bottom: 4vh;
                font-size: 1.5rem;
                display: flex;
                height: 2vh;
            }
            #menuOption-settings-container{
                grid-area: 1 / 1 / 1 / 2;
            }
            #menuOption-file-container{
                grid-area: 1 / 2 / 1 / 3;
            }

            .mainMenu-option div{
                align-self: center; 
                padding-left: 1rem;
                font-size: 1.25rem;
            }
            .mainMenu-option.small{
                margin-bottom: 1vh;
                font-size: 1rem;
            }
            .main-nav a {
                display: inline-block;
                white-space: nowrap;
                font-weight: 300;
                margin: 0 0 30px 0;
                color: #fff;
                -webkit-transition: color 0.3s;
                transition: color 0.3s;
                -webkit-transform-style: preserve-3d;
                transform-style: preserve-3d;
            }
            .menuOption{
                cursor: pointer;
                transition: all 250ms;
            }
            .menuOption:hover{
                font-weight: bold;
            }
            .checkbox-header{
                padding-top: 1rem;
            }
            .checkbox-container{
                padding-top: 1rem;
            }

    </style>
</head>

<body>
    <!-- MAIN CONTENT -->
    <main id="content" class="perspective effect-rotateRight">
        <div id = "content-bg">
            <svg viewBox="0 0 51 55" height = "100%">
                 <use href="#nswGov-watermark"/>
             </svg>
        </div>
      
        <nav class="main-nav">
            <div id = "mainMenu-container">
                <div class = "mainMenu-header">Net Zero Pathways:<br>Data parsing tool</div>
                <hr>
                <div>
                    <div class = "mainMenu-option small" >Follow these steps to prepare the data.js file for the NZP tool</div>
                    <div class = "mainMenu-option">
                        <div id = "menuOption-casper" class = "menuOption" onclick= "loadCASPER()">1 . Load the CASPER data file</div>
                    </div>
                    <div href="#" class = "mainMenu-option">
                        <div id = "menuOption-grep" class = "menuOption">2. Load the GREP data file</div>
                    </div>

                    <div class = "mainMenu-option">
                        <div id = "menuOption-export" class = "menuOption">3. Export the data.js file</div>
                    </div>
                <hr>
                <div class = "checkbox-header">Data preparation options:</div>
                <div class = "checkbox-container">
                    <input type="checkbox" id="option-A" name="excludeAll" value="excludeAll">
                    <label for="excludeAll">Exclude all negative consumption</label>
                </div>
                <div class = "checkbox-container">
                    <input type="checkbox" id="option-B" name="excludeUnassigned" value="excludeUnassigned" checked>
                    <label for="excludeUnassigned">Exclude negative consumption not assigned to NZP Tool site groups (i.e. modelled building types)</label>
                </div>
                <input type="file" name = "file" id="hidden-file-upload">                
                </div>       
            </div> 
        </nav>     

        <section id = "detailsPane-container" class = "hidden">
            <div id = "detailsPane-content-container"></div>
        </section>
        <!-- SVG DEFS -->
        <defs hidden>
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 51 55" xml:space="preserve">
                <g id = "nswGov-logo">
                    <polygon fill="#1D3278" points="45.946,32.777 43.739,42.273 41.42,32.777 38.229,32.777 35.871,42.168 33.73,32.777 30.243,32.777 34.102,47.604 37.531,47.604 39.795,38.227 42.097,47.604 45.466,47.604 45.498,47.48 49.382,32.777  "/>
                    <polygon fill="#1D3278" points="13.978,42.252 5.909,32.777 2.49,32.777 2.49,47.607 5.821,47.607 5.821,38.154 13.866,47.607 17.308,47.607 17.308,32.777 13.978,32.777 "/>
                    <path fill="#1D3278" d="M2.137,52.156v-0.014c0-1.285,0.983-2.373,2.367-2.373c0.802,0,1.292,0.223,1.766,0.621l-0.513,0.615 
                        c-0.356-0.305-0.704-0.494-1.287-0.494c-0.845,0-1.488,0.738-1.488,1.617v0.014c0,0.943,0.622,1.641,1.559,1.641 
                        c0.435,0,0.826-0.141,1.11-0.35v-0.857H4.478v-0.703h1.955v1.928C5.981,54.189,5.33,54.52,4.518,54.52 
                        C3.082,54.52,2.137,53.494,2.137,52.156"/>
                    <path fill="#1D3278" d="M6.919,52.156v-0.014c0-1.293,0.999-2.373,2.405-2.373c1.411,0,2.395,1.07,2.395,2.359v0.014 
                        c0,1.291-0.996,2.377-2.407,2.377C7.902,54.52,6.919,53.447,6.919,52.156 M10.874,52.156v-0.014c0-0.893-0.651-1.631-1.561-1.631c-0.911,0-1.545,0.729-1.545,1.617v0.014c0,0.893,0.648,1.635,1.558,1.635C10.239,53.777,10.874,53.049,10.874,52.156"/>
                    <polygon fill="#1D3278" points="11.661,49.846 12.554,49.846 13.938,53.375 15.313,49.846 16.187,49.846 14.278,54.471 13.57,54.471 "/>
                    <polygon fill="#1D3278" points="16.729,49.846 20.133,49.846 20.133,50.57 17.536,50.57 17.536,51.764 19.839,51.764 
                        19.839,52.484 17.536,52.484 17.536,53.717 20.168,53.717 20.168,54.438 16.729,54.438 "/>
                    <path fill="#1D3278" d="M20.95,49.846h2.046c0.577,0,1.03,0.176,1.325,0.459c0.243,0.252,0.379,0.592,0.379,0.99v0.014 
                        c0,0.756-0.452,1.209-1.096,1.395l1.241,1.734h-0.952l-1.127-1.598h-1.012v1.598H20.95V49.846z 
                        M22.937,52.125 c0.577,0,0.945-0.305,0.945-0.77V51.34c0-0.49-0.355-0.758-0.952-0.758h-1.174v1.543H22.937z"/>
                    <polygon fill="#1D3278" points="25.412,49.846 26.158,49.846 28.618,53.02 28.618,49.846 29.411,49.846 29.411,54.438 28.734,54.438 26.203,51.172 26.203,54.438 25.412,54.438 "/>
                    <polygon fill="#1D3278" points="30.229,49.846 31.088,49.846 32.485,52.02 33.882,49.846 34.741,49.846 34.741,54.438 33.936,54.438 33.936,51.145 32.485,53.311 32.46,53.311 31.024,51.158 31.024,54.438 30.229,54.438 "/>
                    <polygon fill="#1D3278" points="35.512,49.846 38.913,49.846 38.913,50.57 36.318,50.57 36.318,51.764 38.62,51.764 38.62,52.484 
                        36.318,52.484 36.318,53.717 38.949,53.717 38.949,54.438 35.512,54.438  "/>
                    <polygon fill="#1D3278" points="39.741,49.846 40.488,49.846 42.949,53.02 42.949,49.846 43.744,49.846 43.744,54.438 43.068,54.438 40.536,51.172 40.536,54.438 39.741,54.438 "/>
                    <polygon fill="#1D3278" points="45.837,50.596 44.382,50.596 44.382,49.85 48.105,49.85 48.105,50.596 46.65,50.596 46.65,54.438 45.837,54.438  "/>
                    <path fill="#1D3278" d="M18.224,45.541l1.96-2.346c1.356,1.117,2.777,1.832,4.498,1.832c1.356,0,2.175-0.539,2.175-1.422v-0.045
                        c0-0.84-0.517-1.266-3.036-1.914c-3.035-0.777-4.993-1.615-4.993-4.605v-0.043c0-2.732,2.196-4.539,5.274-4.539
                        c2.194,0,4.068,0.686,5.596,1.914l-1.722,2.496c-1.338-0.928-2.648-1.484-3.918-1.484c-1.271,0-1.937,0.582-1.937,1.309v0.045
                        c0,0.99,0.644,1.312,3.25,1.982c3.057,0.793,4.779,1.893,4.779,4.518v0.045c0,2.99-2.28,4.67-5.532,4.67
                        C22.336,47.953,20.033,47.158,18.224,45.541"/>
                    <path fill="#DD0332" d="M10.42,4.628C10.109,4.64,9.925,4.82,9.857,5.185c0,0-0.076,0.539-0.159,1.458
                        C9.62,7.484,9.524,8.816,9.524,10.401c0,3.568,0.468,8.641,2.688,12.531c1.707,2.964,4.114,4.637,6.802,4.725
                        c-1.048-0.802-2.294-2.132-2.957-4.197c-0.624-1.963-0.942-4.281-0.942-6.891c0-3.605,0.603-6.694,0.79-7.559
                        c0.003-0.021,0.006-0.035,0.008-0.043c0.107-0.5,0.397-0.901,0.784-1.104c-2.739-1.759-5.098-2.793-5.552-2.988
                        c-0.273-0.125-0.422-0.178-0.422-0.18h-0.005l-0.003-0.002C10.615,4.651,10.517,4.628,10.42,4.628"/>
                    <path fill="#DD0332" d="M33.769,8.798c-0.068,0-0.146,0.032-0.231,0.099c-0.002,0.001-0.085,0.064-0.239,0.199
                        c-0.158,0.124-0.381,0.315-0.688,0.589c-0.41,0.366-1.247,1.139-2.222,2.212c-1.547,1.72-3.597,4.433-4.569,7.574
                        c-0.56,1.83-0.84,3.418-0.831,4.714c-0.011,0.969,0.143,1.792,0.457,2.443c0.299,0.633,0.753,1.084,1.392,1.379
                        c0.27,0.118,0.608,0.177,1.013,0.177h0.019c1.874,0,5.003-1.563,6.08-5.042c0.581-1.874,0.874-4.085,0.874-6.574
                        c0-3.089-0.446-5.781-0.642-6.795c-0.073-0.373-0.115-0.578-0.115-0.578C34.018,9.019,33.928,8.798,33.769,8.798"/>
                    <path fill="#DD0332" d="M17.275,8.798c-0.166,0-0.264,0.219-0.318,0.403c-0.007,0.035-0.047,0.234-0.115,0.574
                        c-0.052,0.257-0.156,0.811-0.268,1.593c-0.176,1.222-0.386,3.113-0.386,5.201c0,2.528,0.299,4.736,0.885,6.562
                        c1.103,3.486,4.308,5.053,6.231,5.053h0.021c0.404,0,0.761-0.062,1.059-0.191c0.158-0.063,0.309-0.144,0.478-0.263
                        c-0.142-0.188-0.268-0.401-0.382-0.641c-0.376-0.78-0.562-1.729-0.575-2.9c0.012-1.446,0.315-3.14,0.901-5.031
                        c0.049-0.175,0.11-0.352,0.17-0.521c0.023-0.068,0.047-0.137,0.072-0.205c-2.046-5.081-6.744-8.911-7.275-9.333
                        c-0.167-0.137-0.254-0.201-0.254-0.203C17.425,8.832,17.342,8.798,17.275,8.798"/>
                    <path fill="#DD0332" d="M25.505,0.481c-0.113,0-0.23,0.089-0.348,0.268c-0.004,0.003-0.098,0.142-0.254,0.4
                        c-0.234,0.393-0.46,0.776-0.686,1.171c-0.508,0.897-1.276,2.348-2.068,4.152c-0.543,1.234-1.038,2.515-1.47,3.813
                        c1.522,1.521,3.562,3.894,4.921,6.772c1.048-2.256,2.644-4.503,4.744-6.685c-1.433-4.349-3.443-7.895-4.246-9.223
                        c-0.171-0.266-0.259-0.408-0.259-0.408C25.678,0.5,25.542,0.481,25.505,0.481"/>
                    <path fill="#DD0332" d="M40.566,4.628c-0.059,0-0.159,0.014-0.283,0.064L40.28,4.695h-0.003c-0.002,0.001-0.151,0.055-0.419,0.178
                        c-0.262,0.106-0.606,0.27-1.048,0.476l-0.154,0.072c-1.353,0.656-2.671,1.387-3.916,2.173c-0.144,0.081-0.283,0.168-0.422,0.262
                        c0.383,0.193,0.681,0.601,0.788,1.104c0.003,0.014,0.006,0.028,0.01,0.051c0.184,0.862,0.779,3.953,0.779,7.556
                        c0,2.597-0.31,4.915-0.921,6.891c-0.653,2.073-1.87,3.398-2.893,4.194c2.646-0.127,5.02-1.792,6.704-4.725
                        c2.222-3.887,2.688-8.959,2.688-12.527c0-1.264-0.056-2.533-0.171-3.77c-0.085-0.908-0.16-1.449-0.16-1.455
                        C41.076,4.82,40.888,4.64,40.566,4.628"/>
                    <path fill="#DD0332" d="M33.22,1.611c-0.034,0-0.07,0.003-0.105,0.008H33.11h-0.003c-0.083,0.009-0.166,0.042-0.252,0.102
                        l-0.005,0.003l-0.004,0.002c-0.006,0.005-0.587,0.36-1.484,1.006c-0.498,0.355-1.288,0.945-2.256,1.745
                        c0.703,1.459,1.332,2.948,1.872,4.431c1.157-0.91,2.42-1.776,3.859-2.643c-0.405-2.061-0.874-3.594-1.057-4.165
                        c-0.008-0.02-0.012-0.033-0.015-0.044C33.654,1.762,33.471,1.611,33.22,1.611"/>
                    <path fill="#DD0332" d="M17.779,1.611c-0.25,0-0.433,0.15-0.546,0.446c-0.004,0.011-0.007,0.024-0.015,0.044
                        c-0.183,0.571-0.65,2.104-1.056,4.165c1.438,0.866,2.703,1.73,3.856,2.641c0.513-1.439,1.144-2.928,1.874-4.43
                        c-0.765-0.633-1.524-1.22-2.256-1.745c-0.897-0.646-1.48-1.001-1.485-1.006l-0.004-0.002l-0.003-0.003
                        c-0.085-0.06-0.17-0.093-0.25-0.102h-0.006h-0.003C17.85,1.613,17.814,1.611,17.779,1.611"/>
                    <path fill="#DD0332" d="M4.817,11.256c-0.779,0-1.23,0.023-1.235,0.023c-0.307,0.02-0.59,0.188-0.776,0.464
                        c-0.11,0.163-0.167,0.368-0.157,0.569c0.054,0.536,0.411,2.478,2.728,5.402c1.188-0.589,2.368-1.107,3.508-1.543
                        c-0.236-1.458-0.377-3.047-0.416-4.732c-1.419-0.131-2.536-0.172-3.232-0.18C5.088,11.256,4.947,11.256,4.817,11.256"/>
                    <path fill="#DD0332" d="M46.181,11.256c-0.131,0-0.271,0-0.42,0.002c-0.692,0.008-1.811,0.049-3.228,0.18
                        c-0.039,1.622-0.183,3.214-0.42,4.732c1.143,0.434,2.319,0.954,3.509,1.543c2.322-2.933,2.679-4.875,2.731-5.405
                        c0.018-0.181-0.082-0.457-0.158-0.565c-0.188-0.276-0.471-0.444-0.778-0.464C47.412,11.279,46.953,11.256,46.181,11.256"/>
                    <path fill="#DD0332" d="M41.919,17.254c-0.475,2.39-1.217,4.48-2.207,6.213c-1.033,1.813-2.324,3.188-3.846,4.096
                        c11.03-0.6,14.144-4.147,14.468-4.558h0.002c0.11-0.167,0.164-0.353,0.164-0.547c0-0.321-0.148-0.63-0.391-0.804
                        c0,0-0.13-0.088-0.361-0.246l-0.002-0.003l-0.005-0.003c-0.172-0.129-0.425-0.298-0.747-0.505
                        c-0.083-0.055-0.172-0.115-0.264-0.174c-0.791-0.508-2.059-1.277-3.616-2.054C44.038,18.126,42.966,17.65,41.919,17.254"/>
                    <path fill="#DD0332" d="M9.082,17.254c-3.72,1.41-6.715,3.368-7.839,4.151c-0.225,0.165-0.352,0.249-0.357,0.252
                        C0.65,21.829,0.5,22.138,0.5,22.458c0,0.194,0.055,0.376,0.163,0.543c0.009,0.01,0.016,0.021,0.02,0.028
                        c0.023,0.024,0.046,0.052,0.072,0.084c0.014,0.017,0.028,0.034,0.045,0.052c0.075,0.083,0.25,0.269,0.528,0.496
                        c0.464,0.399,1.299,0.998,2.641,1.604c2.778,1.257,6.627,2.054,11.165,2.307c-1.503-0.903-2.822-2.313-3.844-4.105
                        C10.298,21.731,9.556,19.645,9.082,17.254"/>
                    <path fill="#DD0332" d="M40.536,28.37c-0.563,0-1.401,0.116-2.668,0.292c-0.186,0.023-0.383,0.051-0.588,0.078
                        c-0.555,0.078-1.229,0.117-2.122,0.117c-0.549,0-1.116-0.014-1.719-0.029l-0.052-0.002c-0.573-0.01-1.221-0.025-1.872-0.025
                        c-1.352,0-3.099,0.057-4.639,0.484c-0.076,0.023-0.131,0.104-0.123,0.16c0.006,0.049,0.1,0.066,0.181,0.066
                        c0.022,0,0.048-0.004,0.071-0.004c0.611-0.053,1.203-0.08,1.76-0.08c2.008,0,3.382,0.348,4.71,0.68
                        c1.246,0.318,2.427,0.615,4.063,0.615c1.747,0,3.132-0.371,3.701-0.996c0.19-0.211,0.277-0.439,0.256-0.682
                        C41.449,28.58,41.301,28.37,40.536,28.37"/>
                    <path fill="#DD0332" d="M10.459,28.37c-0.762,0-0.908,0.21-0.956,0.675c-0.023,0.242,0.06,0.471,0.247,0.676
                        c0.558,0.621,1.981,1.002,3.71,1.002c1.638,0,2.817-0.297,4.067-0.615c1.325-0.332,2.698-0.684,4.709-0.68
                        c0.554,0,1.146,0.027,1.754,0.08c0.028,0,0.051,0.004,0.074,0.004c0.081,0,0.176-0.018,0.183-0.066
                        c0.007-0.057-0.049-0.137-0.129-0.16c-1.537-0.428-3.285-0.484-4.636-0.484c-0.649,0-1.298,0.016-1.869,0.025l-0.055,0.002
                        c-0.603,0.016-1.169,0.029-1.717,0.029c-0.895,0-1.57-0.039-2.123-0.117c-0.21-0.027-0.413-0.059-0.604-0.082
                        C11.856,28.486,11.022,28.37,10.459,28.37"/>
                </g>
            </svg>
            <svg id = "icon-menu" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"   class = "overlay-nav-icon">
              <path d="M89.23 18.043H10.77C7.583 18.043 5 20.35 5 23.197s2.583 5.154 5.77 5.154h78.46c3.187 0 5.77-2.307 5.77-5.154s-2.583-5.154-5.77-5.154z"/>
              <path d="M89.23 44.846H10.77c-3.187 0-5.77 2.309-5.77 5.155s2.583 5.154 5.77 5.154h78.46c3.187 0 5.77-2.309 5.77-5.155 0-2.845-2.583-5.153-5.77-5.153z"/>
              <path d="M89.23 71.65H10.77C7.583 71.65 5 73.957 5 76.803c0 2.847 2.583 5.155 5.77 5.155h78.46c3.187 0 5.77-2.309 5.77-5.155 0-2.845-2.583-5.153-5.77-5.153z"/>
            </svg>
            <svg  id = "icon-help" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" class = "overlay-nav-icon">
                <path d="M24.25 13h1.5c.831 0 1.5.669 1.5 1.5V16c0 .831-.669 1.5-1.5 1.5h-1.5c-.831 0-1.5-.669-1.5-1.5v-1.5c0-.831.669-1.5 1.5-1.5zm0 6h1.5c.831 0 1.5.669 1.5 1.5v15c0 .831-.669 1.5-1.5 1.5h-1.5c-.831 0-1.5-.669-1.5-1.5v-15c0-.831.669-1.5 1.5-1.5zM25 2.5A22.5 22.5 0 1047.5 25 22.5 22.5 0 0025 2.5zm0 42A19.5 19.5 0 1144.5 25 19.5 19.5 0 0125 44.5z"/>
            </svg>
            <svg id = "nswGov-watermark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 132">
                <g transform="matrix(.24706 0 0 .24706 -107.997 -12.839)">
                    <clipPath id="a">
                        <path d="M437.128 51.969h404.761v543.307H437.128z" clip-rule="nonzero"/>
                    </clipPath>
                    <g clip-path="url(#a)">
                        <path fill-rule="nonzero" d="M512.966 241.132c2.295 0 4.74.009 7.34.035 12.204.152 31.814.829 56.691 3.163.697 28.493 3.17 56.409 7.375 83.067-20.046 7.605-40.749 16.704-61.613 27.057-40.788-51.433-46.997-85.548-47.928-94.851-.307-3.182 1.43-8.013 2.762-9.944 3.293-4.851 8.257-7.8 13.659-8.118.059-.004 8.137-.409 21.714-.409"/>
                        <path fill-rule="nonzero" d="M875.839 512.725c-5.226 11.156-12.092 17.255-23.297 22.407-4.696 2.095-10.68 3.154-17.762 3.154h-.338c-32.91 0-87.808-27.454-106.753-88.507-10.18-32.895-15.347-71.731-15.347-115.414 0-54.225 7.872-101.484 11.267-119.282 1.31-6.554 2.064-10.129 2.064-10.138.811-3.118 2.375-6.973 5.172-6.973 1.231 0 2.553.563 4.065 1.72.039.03 1.508 1.142 4.218 3.489 2.737 2.193 6.649 5.557 12.05 10.347 7.226 6.426 21.911 20.018 39.039 38.855 27.134 30.214 63.08 77.805 80.172 132.923 2.174 7.097 3.758 11.761 5.45 18.43"/>
                        <path fill-rule="nonzero" d="M875.838 342.781c-18.412-39.597-48.003-78.868-84.854-117.174 25.14-76.319 60.445-138.566 74.524-161.883a661.832 661.832 0 004.517-7.149c2.838-4.268 5.217-4.606 5.88-4.607"/>
                        <path fill-rule="nonzero" d="M611.486 124.782c1.068.008 2.801.208 4.991 1.121l.062.028.054.02c.033.009 2.622.943 7.336 3.118 4.61 1.883 10.705 4.739 18.413 8.356l2.697 1.258c23.752 11.499 46.884 24.336 68.752 38.138 2.491 1.421 4.977 2.994 7.44 4.601-6.761 3.421-11.967 10.54-13.877 19.412-.052.224-.102.478-.19.878-3.193 15.124-13.639 69.384-13.639 132.654 0 45.581 5.432 86.271 16.141 120.924 11.489 36.449 32.848 59.69 50.8 73.633-46.49-2.174-88.135-31.423-117.702-82.88-39.005-68.249-47.184-157.272-47.184-219.942 0-22.181 1.009-44.442 3.002-66.158 1.484-15.963 2.801-25.437 2.81-25.534 1.174-6.259 4.48-9.449 10.094-9.627"/>
                        <path fill-rule="nonzero" d="M740.478 71.791c.604 0 1.228.051 1.849.148l.076.006.064.008c1.428.146 2.908.747 4.415 1.808l.069.042.071.043c.107.067 10.304 6.318 26.059 17.625 8.744 6.264 22.598 16.6 39.584 30.644-12.324 25.618-23.372 51.751-32.865 77.787-20.274-15.967-42.478-31.178-67.717-46.405 7.148-36.17 15.319-63.093 18.547-73.096.112-.346.186-.597.251-.782 1.966-5.191 5.196-7.828 9.597-7.828"/>
                        <path fill-rule="nonzero" d="M587.77 346.384c8.341 41.964 21.37 78.645 38.757 109.051 18.113 31.84 40.783 55.98 67.472 71.936-193.607-10.517-248.251-72.813-253.947-80.011l-.029-.043c-1.925-2.924-2.895-6.148-2.895-9.592 0-5.572 2.627-10.981 6.858-14.114.007 0 2.275-1.51 6.34-4.275l.046-.042.051-.042c3.067-2.324 7.505-5.233 13.113-8.912a923.349 923.349 0 004.664-3.059c13.865-8.893 36.156-22.388 63.493-36.058 18.876-9.537 37.721-17.885 56.077-24.839"/>
                        <path fill-rule="nonzero" d="M612.044 541.528c9.92 0 24.596 2.019 46.793 5.079l10.355 1.428c9.718 1.373 21.564 2.009 37.272 2.009 9.611 0 19.585-.224 30.15-.463l.936-.021c10.037-.223 21.423-.477 32.835-.477 23.721 0 54.397.961 81.428 8.499 1.359.401 2.34 1.862 2.201 2.802-.133.875-1.802 1.174-3.209 1.174-.401 0-.816-.014-1.261-.053-10.717-.95-21.092-1.426-30.86-1.426-35.28 0-59.367 6.084-82.664 11.965-21.918 5.538-42.622 10.76-71.384 10.76-30.665 0-54.955-6.528-64.962-17.472-3.354-3.672-4.867-7.685-4.483-11.931.806-8.198 3.43-11.873 16.853-11.873"/>
                    </g>
                </g>
            </svg>
            <svg id = "uptake-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 90 63.622">
              <path d="M74.776 31.85c-1.14 0-2.195.33-3.115.866L61.464 19.505a6.159 6.159 0 00.9-3.173 6.207 6.207 0 00-12.415 0c0 .228.041.439.066.657l-10.31 3.867c-1.092-1.775-3.037-2.973-5.274-2.973a6.206 6.206 0 00-6.207 6.207c0 1.338.431 2.568 1.15 3.582l-10.56 15.846c-.895-.497-1.908-.807-3.002-.807a6.206 6.206 0 00-6.207 6.207 6.207 6.207 0 0012.414 0 6.171 6.171 0 00-1.152-3.581L31.43 29.49c.894.497 1.907.807 3.003.807a6.207 6.207 0 006.207-6.207c0-.228-.042-.44-.068-.658l10.311-3.867c1.093 1.776 3.037 2.974 5.275 2.974a6.155 6.155 0 003.42-1.034l10.075 13.052a6.206 6.206 0 005.125 9.706 6.207 6.207 0 100-12.414M15.811 52.409a3.495 3.495 0 01-3.492-3.491 3.496 3.496 0 013.492-3.491 3.496 3.496 0 013.491 3.49 3.496 3.496 0 01-3.49 3.492m18.62-24.827a3.495 3.495 0 01-3.492-3.491 3.496 3.496 0 013.491-3.491 3.495 3.495 0 013.491 3.49 3.495 3.495 0 01-3.49 3.492m21.723-7.76a3.494 3.494 0 01-3.49-3.49 3.495 3.495 0 013.49-3.491 3.496 3.496 0 013.491 3.49 3.494 3.494 0 01-3.49 3.492m18.62 21.725a3.495 3.495 0 01-3.492-3.492 3.496 3.496 0 013.491-3.491 3.496 3.496 0 013.492 3.49 3.495 3.495 0 01-3.492 3.493M82.241 0H7.759A7.759 7.759 0 000 7.759v48.104a7.758 7.758 0 007.759 7.759h74.482A7.76 7.76 0 0090 55.863V7.759A7.76 7.76 0 0082.241 0m4.655 55.863a4.655 4.655 0 01-4.655 4.655H7.759a4.655 4.655 0 01-4.655-4.655V7.759a4.655 4.655 0 014.655-4.655h74.482a4.656 4.656 0 014.655 4.655z"/>
            </svg>
        </defs>
    </main><!-- /perspective -->

	<!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/filesaver.js/0.1/FileSaver.min.js"></script>        
    <script src="https://d3js.org/d3.v5.min.js"></script>   
    <!-- Data parsing tool script --> 
    <script>

        /////////////////////////////////////////////////
        ///////  MODEL DATA AND SETTINGS OBJECTS  /////// 
        /////////////////////////////////////////////////

            const data = {}        // declare the data object before loading consumption.js 
            const dataOutput = {}
            // Model data object: input data
            const dataModel = {
                consumption:            {},
                siteMeta:               [],
                schema: {
                    baselineYear:           '',
                    consumption:            {},
                    dataSets:{      // Allocation of "Dataset (source) to emissions source
                        "776":          {name: "Small sites electricity",           type: "ELEC"    },
                        "777":          {name: "Large sites electricity",           type: "ELEC"    },
                        "C349":         {name: "LPG contract",                      type: "LPG"     },
                        "C4000":        {name: "Natural gas contract",              type: "NG"      }, 
                        "H2O/HW":       {name: "Unknown water contract",            type: "WATER"   }, 
                        "H2O/SW":       {name: "Unknown water contract",            type: "WATER"   }, 
                        "SW/SW":        {name: "Sydney water",                      type: "WATER"   }, 
                        "SW/HW":        {name: "Sydney/Hunter water",               type: "WATER"   }, 
                        "SW/SW":        {name: "Sydney water",                      type: "WATER"   }, 
                        "OFF/WATER":    {name: "Off contract water",                type: "WATER"   }, 
                        "OFF/ELEC":     {name: "Off contract electricity",          type: "ELEC"    },
                        "OFF/LPG":      {name: "Off contract LPG",                  type: "LPG"     },  
                        "OFF/NG":       {name: "Off contract natural gas",          type: "NG"      },
                        "OFF/WASTE":    {name: "Off contract waste (various)",      type: "CI_WASTE"},      // A match is done based on only the first characters

                        "WOA/ELEC":     {name: "WoA Electricity",                   type: "ELEC"    },
                        "WOA/LPG":      {name: "WoA LPG",                           type: "LPG"     },  
                        "WOA/NG":       {name: "WoA Natural gas",                   type: "NG"      },
                        "WOA/WATER":    {name: "WoA Water",                         type: "WATER"   },
                        "WOA/WASTE":    {name: "WoA Waste",                         type: "CI_WASTE"},
                    },
                    unitConversion:{
                        MWh: {
                                "MWh":      1,
                                "kWh":      0.001
                        },
                        GJ: {
                                "GJ":       1,          
                                "MJ":       0.001                       
                        },
                        kL: {
                                "kL":       1,                      
                                "kl":       1,                      
                                "l":        0.001,                          
                                "L":        0.001,                          
                                "litres":   0.001,                          
                        },
                        tonnes: {
                            "General waste-Cubic metres":       1, 
                            "General waste-Litres":             0.001,
                            "General waste-Tonnes":             1,
                            "Landfill-Cubic metres":            1.2 / 3,
                            "Landfill-Litres":                  0.001,
                            "Landfill-Tonnes":                  1,
                            "tonnes":                           1
                        }   
                    },
                    clusterMapping:     {
                        clusterList:                    [],
                        agencyList:                     [],
                        agencyToCluster:                {}
                    },
                    typologyMapping:    {
                        modelSitetypeToSitegroup :      {}
                    }, 
                    grepProjects:           {}
                },
                sitegroupAgency:        {}
            }
            const helpers = {
                parseTimeA:         d3.timeParse("%d/%m/%Y"),
                parseTimeB:         d3.timeParse("%d/%m/%y")
            }

            let loadedDataType

            const gSheetTables = {
                typologySchema:     'https://docs.google.com/spreadsheets/d/e/2PACX-1vSeBcs4QqJvlTntRk1vS5kAnhGh9hjqr_T6bqR4JTEYIVITp6leQ6mZmtqdwWgE8jxRF1Q4Def1QIH4/pub?gid=47239118&single=true&output=tsv',
                siteData:           'https://docs.google.com/spreadsheets/d/e/2PACX-1vSeBcs4QqJvlTntRk1vS5kAnhGh9hjqr_T6bqR4JTEYIVITp6leQ6mZmtqdwWgE8jxRF1Q4Def1QIH4/pub?gid=1010190784&single=true&output=tsv'
            }

        ////////////////////////////////////////////
        /// DPIE NET ZERO DATA PREPARATION TOOL  ///
        ////////////////////////////////////////////

            getSchema()
            addUploadHandler()
            d3.selectAll('#menuOption-grep, #menuOption-export').style('opacity', 0.5)


        ///////////////////////////
        /// GET DATA AND SCHEMA ///
        ///////////////////////////


            async function getSchema() {
                data.typologySchema = await d3.tsv(gSheetTables.typologySchema)
                data.siteData = await d3.tsv(gSheetTables.siteData)                                                   
            };

            function loadCASPER(){
                loadedDataType = 'casper'
                document.getElementById("hidden-file-upload").click();
            };

            function loadGREP(){
                loadedDataType = 'grep'
                document.getElementById("hidden-file-upload").click();                  
            };

            // Handler for hidden file selector 
            function addUploadHandler() {
                d3.select("#hidden-file-upload").on("change", function(){       // Opens file selection window  
                    if (window.File && window.FileReader && window.FileList && window.Blob) {
                        console.log('Data loading... ')     

                        const uploadFile = this.files[0],
                            filereader = new window.FileReader()
                        filereader.readAsText(uploadFile)
                   
                        filereader.onload = async function(){
                            if(loadedDataType === 'casper'){
                                data.consumption = JSON.parse(tsvJSON(filereader.result))
                                await parseCasperData()
                                d3.select('#menuOption-casper')
                                    .attr('onclick', null)
                                    .style('opacity', 0.5)

                            } else if(loadedDataType === 'grep'){
                                data.grepProjects = JSON.parse(tsvJSON(filereader.result))
                                await parseGrepData()
                                d3.select('#menuOption-grep')
                                    .attr('onclick', null)
                                    .style('opacity', 0.5)                      
                            }
                        }

                    } else {
                        alert("Your browser won't let you save this file -- try using Chrome, Firefox, Safari or Edge.");
                    }
                });   
            }; 


        ////////////////////////////////////////
        /// DATA PARSING AND OUTPUT CREATION ///
        ////////////////////////////////////////

            async function parseCasperData(){
                console.log('*** PARSING CASPER DATA ***')
                // 0. SET MODE
                    const mode = document.getElementById('option-A').checked ? 'removeAll' : document.getElementById('option-B').checked  ? 'removeUnassigned' : 'processAll'
                // 1. EXTRACT SITE GROUP TYPOLOGY SCHEMA
                    dataModel.schema.typologyMapping.modelSitetypeList   = [...new Set(data.typologySchema.map(d => d.siteType) )]

                    dataModel.schema.typologyMapping.sitetypeBySitegroup = d3.nest()
                        .key(d => d.siteGroup)
                        .rollup(v => v.map(d => d.siteType) )               
                        .entries(data.typologySchema.filter( d => d.siteGroup !== ''))

                    dataModel.schema.typologyMapping.modelSitetypeList.forEach( sitetype => {
                        let group 

                        dataModel.schema.typologyMapping.sitetypeBySitegroup.forEach(obj => {
                            if(obj.value.indexOf(sitetype) > -1) { 
                                group = obj.key 
                            }
                        })
                        dataModel.schema.typologyMapping.modelSitetypeToSitegroup[sitetype] = group
                    })

                // 2. EXTRACT AGENCIES WITH MANUALLY SET SITES
                    const sitegroupsWithManuallySetSites = [...new Set(data.siteData.map(d => d.sitegroup))]
                    sitegroupsWithManuallySetSites.forEach(sitegroup => {
                        dataModel.sitegroupAgency[sitegroup] = []
                        data.siteData.forEach( d => {
                            if(d.sitegroup === sitegroup){
                                dataModel.sitegroupAgency[sitegroup].push(d.agency)
                            }
                        })              
                    })

                // 3. PARSE SYSTEM EXTRACTED CONSUMPTION DATA
                    // i. Parse all data rows  
                        data.consumption = data.consumption.map( (d,i) => {     

                            const sitegroup = typeof dataModel.schema.typologyMapping.modelSitetypeToSitegroup[d['Site Type'].replace(/['"]+/g, '')] !== 'undefined' ? dataModel.schema.typologyMapping.modelSitetypeToSitegroup[d['Site Type'].replace(/['"]+/g, '')] : "Unassigned",
                                id = d['Site Id'] === "0" ? d['Agency name'].replace(/['"]+/g, '')+'_ALL' : d['Site Id']+'_'+d['Agency name'].replace(/['"]+/g, ''),
                                source = d["Dataset (source)"].toUpperCase().slice(0,9) === "OFF/WASTE" ? 
                                    dataModel.schema.dataSets["OFF/WASTE"].type : 
                                    dataModel.schema.dataSets[d["Dataset (source)"].toUpperCase()].type

                            let consumption, unit
                            switch(source){
                                case 'CI_WASTE': // Include 
                                    consumption = (typeof dataModel.schema.unitConversion.tonnes[d.Units] !== 'undefined') ? d['Consumption'] * dataModel.schema.unitConversion.tonnes[d.Units]: 0
                                    unit = 'tonnes'
                                    break

                                case 'ELEC':
                                    consumption =  +d.Consumption
                                    unit = 'kWh'                        
                                    break

                                case 'NG':
                                    consumption = +d.Consumption
                                    unit: 'MJ'
                                    break

                                case 'LPG':
                                    consumption =  +d.Consumption
                                    unit: 'kL'
                                    break

                                case 'WATER':
                                    consumption =  +d.Consumption
                                    unit: 'kL'
                                    break
                            } 

                            return {
                                id:                 id,     
                                agency:             d['Agency name'].replace(/['"]+/g, ''), 
                                consumption:        consumption,
                                cost:               +d['Cost'],
                                unit:               unit,
                                source:             source ,
                                sitename:           d['Site Name'] === "Site ALL" ? d['Agency name'].replace(/['"]+/g, '')+' - All sites' : d['Site Name'].replace(/['"]+/g, '') ,
                                sitetype:           d['Site Name'] === "Site ALL" ? 'All sites' : d['Site Type'] === "" ? "Not identified" : d['Site Type'].replace(/['"]+/g, ''),
                                sitegroup:          sitegroup,
                                year:               +d["Dataset Year"].slice(0,4) +1,
                                cluster:            d["Cluster"].replace(/['"]+/g, ''),
                                postcode:           d['Postcode'],
                            }
                        })

                    // ii. Filter out any non-consumption records
                        const sitegroupList =  dataModel.schema.typologyMapping.sitetypeBySitegroup.map(d => d.key)
                        data.consumption = data.consumption.filter( d => d.consumption !== 0)

                    // iii. Filter negative consumption as per user setting
                        if(mode === 'removeAll'){
                            data.consumption = data.consumption.filter( d => d.consumption > 0)
                        } 
                        if(mode === 'removeUnassigned'){
                            data.consumption = data.consumption.filter( d => sitegroupList.indexOf(d.sitegroup) > -1 || (d.consumption > 0 && d.sitegroup === 'Unassigned')  )
                        } 

                    // iv. Get Meta-info
                        dataModel.schema.consumption.fieldNames         = Object.keys(data.consumption[0])
                        dataModel.schema.consumption.noRecords          = data.consumption.length
                        dataModel.schema.consumption.agencyList         = [...new Set(data.consumption.map(d => d.agency) )].sort()
                        dataModel.schema.consumption.clusterList        = [...new Set(data.consumption.map(d => d.cluster) )].sort()
                        dataModel.schema.consumption.siteNameList       = [...new Set(data.consumption.map(d => d.sitename) )].sort() 
                        dataModel.schema.consumption.siteTypeList       = [...new Set(data.consumption.map(d => d.sitegroup) )].sort()
                        dataModel.consumption.nested = d3.nest()
                            .key( d => d.cluster)
                            .key( d => d.agency)
                            .key( d => d.sitegroup)
                            .key( d => d.id)
                            .key( d => d.source)
                            .rollup(v => {                      
                                return {
                                    vol:                Math.round(d3.sum(v, d => d.consumption) * 1000) /1000,
                                    cost:               Math.round(d3.sum(v, d => d.cost) *1000) /1000,
                                }
                            })  
                            .entries(data.consumption).sort((a,b) => (a.key > b.key) ? 1 : ((b.key > a.key) ? -1 : 0)); 

                        dataModel.siteMeta = d3.nest()
                            .key( d => d.id)
                            .rollup(v => {                      
                                return {
                                    names:          [...new Set(v.map(d => d.sitename) )],
                                    pc:             v[0].postcode,
                                    type:           v[0].sitetype,
                                    ag:             v[0].agency
                                }
                            })  
                            .entries(data.consumption).sort((a,b) => (a.key > b.key) ? 1 : ((b.key > a.key) ? -1 : 0)); 

                    // iv. Create consumption output data 
                        dataOutput.consumption = dataModel.consumption.nested.map( d => {
                            return { [d.key]: d.values.map( d => { 
                                return { [d.key] : d.values.map( d => { 
                                    return { [d.key] : d.values.map( d => { 
                                        return { [d.key] : d.values.map( d => {
                                            return { [d.key] : d.value } 
                                        }) }
                                    }) }
                                }) }
                            }) } 
                        }) 

                    // iv. Create consumption site meta data 
                        dataOutput.siteMeta = {} 
                        dataModel.siteMeta.forEach( d => {
                            dataOutput.siteMeta[d.key] =  d.value  
                        }) 

                // 5. EXTRACT AND SET THE BASELINE YEAR
                    dataModel.schema.baselineYear = data.consumption[0].year    // Takes the year of the first record

                // 6. Enable GREP LOADING
                    d3.selectAll('#menuOption-grep').attr('onclick', 'loadGREP()').style('opacity', 1)      

                alert('CASPER data sucessfully loaded and parsed')
            }; // end parseData


            async function parseGrepData(){
                console.log('*** PARSING GREP DATA ***')
                // 1. EXTRACT & ANALYSE GREP DATA INCL. estimated OF CURRENT SOLAR INSTALLATIONS
                    // i. Extract schema
                        dataOutput.grepMeta = {
                            projectTypes:   [...new Set(data.grepProjects.map(d => d["Project Type"]))].filter(d => d !=='' && d !== null),
                            years:          [...new Set(data.grepProjects.map(d => d["Financial Year"]) )]
                        }

                    // ii. Parse project data and add meta-data
                        const clensedGREP = [], fieldNames = Object.keys(data.grepProjects[0])
                        data.grepProjects.forEach(d => {
                            // Guard for 'tabs' in the comment fields" which upset the data structure) 
                            if(typeof d['Agency'] !== 'undefined' && dataModel.schema.consumption.agencyList.indexOf(d['Agency'].replace(/['"]+/g, '')) > -1 && !isNaN(+d.OrgId)){                  
                                const startOfFY = new Date(dataModel.schema.baselineYear - 1, 5, 31), 
                                    endOfFY =  new Date(dataModel.schema.baselineYear , 5, 31),
                                    completionDate = helpers.parseTimeB(d['Project Completion']),
                                    siteType = typeof dataOutput.siteMeta[d['Site Id']] !== 'undefined' ? dataOutput.siteMeta[d['Site Id']].type : d['Site Type'] 

                                let obj = {
                                    agency:         typeof dataOutput.siteMeta[d['Site Id']] !== 'undefined' ? dataOutput.siteMeta[d['Site Id']].names[0] : d['Agency'].replace(/['"]+/g, ''), 
                                    sitetype:       siteType,               
                                    siteId:         d['Site Id'],               
                                    eleckWh:        +d['Electricity Consumption Saving kWh'],
                                    gasMJ:          +d['Gas Consumption Saving MJ'],
                                    year:           +d['Financial Year'].slice(0,4) + 1,
                                    baseImpact :    completionDate < startOfFY ? 1 : completionDate< endOfFY ? (endOfFY - completionDate)/ (1000 * 60 * 60 * 24) / 365 : 0,
                                    type:           d['Project Type']   
                                }
                                clensedGREP.push(obj)   
                            }
                            dataOutput.grep = clensedGREP
                        })

                // 2. Enable EXPORT
                    d3.selectAll('#menuOption-export').attr('onclick', 'exportFile()').style('opacity', 1)      

                alert('GREP data sucessfully loaded and parsed')
            }; // end parseData


        ////////////////////////////////////////
        /// EXPORT OF DATA.JS JSON FILE     ///
        ////////////////////////////////////////

            // Save file to external JSON text
                function exportFile(){
                    let blob = new Blob([
                            'let consumptionData = ',
                             window.JSON.stringify(dataOutput.consumption), 
                             ', siteMeta = ', 
                             window.JSON.stringify(dataOutput.siteMeta),
                             ', casperBaselineYear = ',
                             window.JSON.stringify(dataModel.schema.baselineYear),
                             ', grepData = ',
                             window.JSON.stringify(dataOutput.grep), 
                             ', grepMeta = ', 
                             window.JSON.stringify(dataOutput.grepMeta)
                             ], 
                             {type: "text/plain;charset=utf-8"})
                    saveAs(blob, 'data.js');
                    window.alert("The data file has been saved to your download");
                }; // end saveFile()

            // Helper to convert TSV to JSON
                function tsvJSON(tsv){
                  const lines = tsv.split("\n"),
                    result = [],
                    headers =lines[0].split("\t")

                  for(let i = 1; i< lines.length; i++){
                      const obj = {};
                      let currentline = lines[i].split("\t");
                      for(var j = 0; j < headers.length; j++){
                          obj[headers[j]] = currentline[j];
                      }
                      result.push(obj);
                  }
                  //return result; //JavaScript object
                  return JSON.stringify(result); //JSON
                }
    </script>
</body>

</html>